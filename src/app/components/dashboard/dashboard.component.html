<div class="dashboard-container">
  <div *ngIf="isInitialLoad" class="initial-load-container">
    <app-spinner></app-spinner>
    <div class="initial-load-message">
      {{ 'dashboard.loading.all_activities' | translate }}<br>
      <span class="initial-load-submessage">{{ 'dashboard.loading.may_take_time' | translate }}</span>
    </div>
  </div>

  <div *ngIf="isLoading && !isInitialLoad" class="spinner-overlay">
    <app-spinner></app-spinner>
    <div class="spinner-text">{{ 'dashboard.loading.activities' | translate }}</div>
  </div>

  <ng-container *ngIf="!isLoading">
    <div *ngIf="authError" class="error-container">
      <div class="error-message">
        <p>{{ 'errors.session_expired.title' | translate }}</p>
        <button class="retry-button" (click)="reconnectToStrava()">
          {{ 'errors.session_expired.action' | translate }}
        </button>
      </div>
    </div>

    <div *ngIf="error && !authError" class="error-container">
      <div class="error-message">
        <p>{{ error }}</p>
        <button class="retry-button" (click)="loadData()">
          {{ 'errors.loading_error.action' | translate }}
        </button>
      </div>
    </div>

    <div *ngIf="!error && !authError">
      <app-performance-dashboard
        [activities]="runningActivityData">
      </app-performance-dashboard>

      <!-- Streak Section -->
      <div class="streak-section" *ngIf="displayPreferences.showStreaks">
        <app-streak-badge
          [streakInfo]="streakInfo"
          [loading]="isLoading"
          [streakMode]="displayPreferences.streakMode"
          [showLongestStreak]="showLongestStreak">
        </app-streak-badge>
      </div>

      <!-- Goals Section -->
      <div class="goals-section" *ngIf="displayPreferences.showGoals && !isLoading">
        <div class="goals-grid">
          <!-- Goal Cards (limited to 4) -->
          <app-goal-card
            *ngFor="let progress of limitedGoalProgresses"
            [progress]="progress"
            (edit)="onEditGoal($event)"
            (delete)="onDeleteGoal($event)">
          </app-goal-card>

          <!-- Add Goal Card -->
          <button class="add-goal-card" (click)="openCreateGoalForm()">
            <svg viewBox="0 0 24 24" width="32" height="32" class="add-icon">
              <path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
            <span class="add-label">{{ 'dashboard.goals.add' | translate }}</span>
          </button>
        </div>
      </div>

      <div class="activity-type-container">
        <!-- Stats par groupe de sports (dynamique) -->
        <ng-container *ngFor="let groupData of groupedStatsData; trackBy: trackByGroupId">
          <app-stats-list
            [title]="groupData.group.nameKey | translate"
            [stats]="groupData.stats"
            [selectedPeriod]="selectedPeriod"
            [groupColor]="groupData.group.color"
            [groupIcon]="groupData.group.icon"
            [visibleMetrics]="groupData.group.visibleMetrics">
          </app-stats-list>
        </ng-container>

        <app-modern-activity-chart
          [activities]="allActivities"
          [period]="selectedPeriod">
        </app-modern-activity-chart>

        <app-pace-scatter
          [activities]="allActivities">
        </app-pace-scatter>
      </div>
    </div>
  </ng-container>

  <!-- Dev banner déplacé en bas -->
  <div *ngIf="!authError" class="dev-banner">
    <div class="dev-banner-content">
      <svg class="dev-icon" viewBox="0 0 24 24" width="16" height="16">
        <path fill="currentColor"
              d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm-1-5h2v2h-2zm0-8h2v6h-2z"/>
      </svg>
      <span>{{ 'dashboard.dev_banner.title' | translate }}</span>
    </div>
  </div>

  <!-- Goal Form Modal -->
  <app-goal-form
    *ngIf="showGoalForm"
    [goal]="editingGoal"
    [availableSports]="availableSports"
    (save)="onSaveGoal($event)"
    (cancel)="onCancelGoalForm()">
  </app-goal-form>
</div>
