import{N as m,Nb as b,Ob as f,Q as c,V as h,h as v,l as d,o as g,s as u}from"./chunk-S2QCSSTB.js";var o={production:!0,stravaClientId:"140769",stravaClientSecret:"1fe671981432c8de6eae981cec2c87d1499d5f62",redirectUri:"https://alexbsrd.github.io/strava-dashboard/callback"};var l=class n{activities=[];activitiesSubject=new d([]);lastUpdate=null;currentPeriod=null;setActivities(t,e){if(e!=="current_year")this.activities=t;else{let i=new Set(this.activities.map(r=>r.id)),a=t.filter(r=>!i.has(r.id));this.activities=[...this.activities,...a]}this.lastUpdate=new Date,this.currentPeriod=e,this.activitiesSubject.next(t)}getFilteredActivities(t){let e=new Date,i=new Date;switch(t){case"week":i.setDate(e.getDate()-7);break;case"month":i.setDate(e.getDate()-30);break;case"current_year":i=new Date(e.getFullYear(),0,1);break}return this.activities.filter(a=>new Date(a.start_date)>=i)}needsRefresh(t){if(!this.lastUpdate||this.activities.length===0||this.currentPeriod==="week"&&["month","current_year"].includes(t)||this.currentPeriod==="month"&&t==="current_year")return!0;let e=new Date(Date.now()-15*60*1e3);return this.lastUpdate<e}clear(){this.activities=[],this.lastUpdate=null,this.currentPeriod=null,this.activitiesSubject.next([])}getActivities$(){return this.activitiesSubject.asObservable()}getCurrentPeriod(){return this.currentPeriod}static \u0275fac=function(e){return new(e||n)};static \u0275prov=c({token:n,factory:n.\u0275fac,providedIn:"root"})};var _=class n{constructor(t,e){this.http=t;this.activityCache=e}apiUrl="https://www.strava.com/api/v3";clientId=o.stravaClientId;clientSecret=o.stravaClientSecret;redirectUri=o.redirectUri;getActivities(t){if(!this.activityCache.needsRefresh(t))return g(this.activityCache.getFilteredActivities(t));let e=new Date;switch(t){case"week":e.setDate(e.getDate()-7);break;case"month":e.setDate(e.getDate()-30);break;case"current_year":e=new Date(e.getFullYear(),0,1);break}let i=new b().set("Authorization",`Bearer ${localStorage.getItem("strava_token")}`);return this.getAllActivities(e,i).pipe(m(a=>{this.activityCache.setActivities(a,t)}),u(a=>this.activityCache.getFilteredActivities(t)))}authenticate(){let t="read,activity:read_all";window.location.href=`https://www.strava.com/oauth/authorize?client_id=${this.clientId}&redirect_uri=${this.redirectUri}&response_type=code&scope=${t}`}handleAuthCallback(t){return this.http.post(`${this.apiUrl}/oauth/token`,{client_id:this.clientId,client_secret:this.clientSecret,code:t,grant_type:"authorization_code"}).pipe(m(e=>{localStorage.setItem("strava_token",e.access_token),localStorage.setItem("strava_refresh_token",e.refresh_token),localStorage.setItem("strava_token_expires_at",e.expires_at.toString()),localStorage.setItem("strava_athlete_id",e.athlete.id.toString())}))}getActivitiesPage(t,e=1,i){return this.http.get(`${this.apiUrl}/athlete/activities`,{headers:i,params:{after:Math.floor(t.getTime()/1e3).toString(),per_page:"200",page:e.toString()}}).pipe(u(a=>a.map(r=>({id:r.id,name:r.name,distance:r.distance/1e3,moving_time:r.moving_time,elapsed_time:r.elapsed_time,total_elevation_gain:r.total_elevation_gain,start_date:new Date(r.start_date),average_speed:r.average_speed*3.6,type:r.type}))))}getAllActivities(t,e){return new v(i=>{let a=(r,p=[])=>{this.getActivitiesPage(t,r,e).subscribe({next:s=>{s.length===0?(i.next(p),i.complete()):a(r+1,[...p,...s])},error:s=>i.error(s)})};a(1)})}static \u0275fac=function(e){return new(e||n)(h(f),h(l))};static \u0275prov=c({token:n,factory:n.\u0275fac,providedIn:"root"})};export{_ as a};
